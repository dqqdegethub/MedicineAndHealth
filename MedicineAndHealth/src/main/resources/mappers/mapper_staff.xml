<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="MedicineAndHealth.staff">
	<resultMap type="MedicineAndHealth.entity.Staff" id="loginMap">
		<result column="id" property="staffId"/>
		<result column="name" property="staffName"/>
		<result column="partname" property="partment"/>
	</resultMap>
	<resultMap type="MedicineAndHealth.entity.Staff" id="personalInfoMap">
		<result column="id" property="staffId"/>
		<result column="name" property="staffName"/>
		<result column="partname" property="partment"/>
		<result column="phoneNumber" property="phoneNumber"/>
	</resultMap>
	<resultMap type="MedicineAndHealth.entity.Ordercheck" id="OrderMap">
		<result column="medicineId" property="medicineId"/>
		<result column="medicineName" property="medicineName"/>
		<result column="customerName" property="customerName"/>
		<result column="customerid" property="customerId"/>
		<result column="count" property="count"/>
		<result column="packagecode" property="code"/>
		<result column="companyid" property="companyId"/>
	</resultMap>

	<select id="queryStaffExist" parameterType="java.lang.Integer" resultType="java.lang.Integer">
		SELECT
			COUNT(*)
		FROM 
			staff
		WHERE
			id=#{staffId}
	</select>
	
	<select id="queryStaffPwd" parameterType="java.util.Map" resultType="java.lang.Integer">
		SELECT
			COUNT(*)
		FROM 
			staff
		WHERE
			id=#{staffId}
		AND password=#{password}
	</select>
	
	<select id="queryStaffByNameAndId" parameterType="java.util.Map" resultType="java.lang.String">
		SELECT
			problem
		FROM 
			staff
		WHERE
			id=#{staffId}
		AND name=#{staffName}
	</select>
	
	<select id="querySecretProblem" parameterType="java.util.Map" resultType="java.lang.Integer">
		SELECT
			COUNT(*)
		FROM 
			staff
		WHERE
			id=#{staffId}
		AND problem=#{problem}
		AND answer=#{answer}
	</select>
	
	<select id="getstaffId" resultType="java.lang.Integer">
		SELECT
			COUNT(*)
		FROM 
			staff
	</select>
	
	<select id="orderNum" parameterType="java.lang.Integer" resultType="java.lang.Integer">
		SELECT
			COUNT(*)
		FROM 
			indent
		WHERE
			staffid=#{staffId}
		AND state='已发货'
	</select>
	
	<select id="login" parameterType="java.util.Map" resultMap="loginMap">
		SELECT
			id,
			name,
			partname
		FROM
			staff
		WHERE
			id=#{staffId}
		AND password=#{password}
	</select>
	
	<update id="updateStaffPassword" parameterType="java.util.Map">
		UPDATE staff
		SET
			password=#{password}
		WHERE
			id=#{staffId}
	</update>
	
	<select id="searchStaffInfo" parameterType="java.lang.Integer" resultMap="personalInfoMap">
		SELECT
			id,
			name,
			partname,
			phoneNumber
		FROM
			staff
		WHERE
			id=#{staffId}
	</select>
	
	<update id="updateStaffInfo" parameterType="java.util.Map">
		UPDATE staff
		SET
			partname=#{partment},
			phoneNumber=#{phoneNumber}
		WHERE
			id=#{staffId}
	</update>
	
	<insert id="staffInsert" parameterType="MedicineAndHealth.entity.Staff">
		INSERT INTO staff(
			id,
			partname,
			name,
			password,
			phoneNumber,
			problem,
			answer
		)
		VALUES
		(
			#{staffId},#{partment},#{staffName}, #{password}, #{phoneNumber}, #{problem}, #{answer}
		)
	</insert>
	
	<select id="queryOrder" resultMap="OrderMap" parameterType="java.lang.Integer">
		SELECT
			medicine.id as medicineId,
			medicine.name as medicineName,
			customer.username as customerName,
			count,
			packagecode,
			companyid,
			customerid
		FROM
			medicine,indent,customer
		<where>
			medicine.id=indent.medicineid AND indent.customerid=customer.id AND state='未发货'
			<if test="_parameter!=null">
				AND indent.medicineid=#{medicineId}
			</if>
		</where>
	</select>
	
	<update id="updateOrderBySer" parameterType="java.util.Map">
		UPDATE indent
		SET
			staffid=#{staffId},
			packagecode=#{packageCode},
			state='已发货',
			companyid=#{companyId}
		WHERE
			medicineid=#{medicineId} AND customerid=#{customerId} AND state='未发货'
	</update>
	
	<update id="updateMedicineBySer" parameterType="java.util.Map">
		UPDATE medicine
		SET
			amount=amount-#{num}
		WHERE
			id=#{medicineId}
	</update>
	
	<select id="queryMedicineNum" parameterType="java.lang.Integer" resultType="java.lang.Integer">
		SELECT 
			amount
		FROM
			medicine
		WHERE 
			id=#{medicineId} 
	</select>
	
	<insert id="purchaseInsert" parameterType="java.lang.Integer" useGeneratedKeys="true">
		INSERT INTO purchase(
			medicineid
		)
		VALUES
		(
			#{medicineId}
		)
	</insert>
</mapper>